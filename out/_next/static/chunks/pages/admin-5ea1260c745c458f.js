(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[964],{8195:function(e,t,n){(window.__NEXT_P=window.__NEXT_P||[]).push(["/admin",function(){return n(209)}])},5677:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),function(e,t){for(var n in t)Object.defineProperty(e,n,{enumerable:!0,get:t[n]})}(t,{noSSR:function(){return o},default:function(){return i}});let l=n(8754),r=(n(7294),l._(n(8976)));function a(e){return{default:(null==e?void 0:e.default)||e}}function o(e,t){return delete t.webpack,delete t.modules,e(t)}function i(e,t){let n=r.default,l={loading:e=>{let{error:t,isLoading:n,pastDelay:l}=e;return null}};e instanceof Promise?l.loader=()=>e:"function"==typeof e?l.loader=e:"object"==typeof e&&(l={...l,...e}),l={...l,...t};let i=l.loader;return(l.loadableGenerated&&(l={...l,...l.loadableGenerated},delete l.loadableGenerated),"boolean"!=typeof l.ssr||l.ssr)?n({...l,loader:()=>null!=i?i().then(a):Promise.resolve(a(()=>null))}):(delete l.webpack,delete l.modules,o(n,l))}("function"==typeof t.default||"object"==typeof t.default&&null!==t.default)&&void 0===t.default.__esModule&&(Object.defineProperty(t.default,"__esModule",{value:!0}),Object.assign(t.default,t),e.exports=t.default)},2254:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"LoadableContext",{enumerable:!0,get:function(){return a}});let l=n(8754),r=l._(n(7294)),a=r.default.createContext(null)},8976:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"default",{enumerable:!0,get:function(){return h}});let l=n(8754),r=l._(n(7294)),a=n(2254),o=[],i=[],s=!1;function d(e){let t=e(),n={loading:!0,loaded:null,error:null};return n.promise=t.then(e=>(n.loading=!1,n.loaded=e,e)).catch(e=>{throw n.loading=!1,n.error=e,e}),n}class u{promise(){return this._res.promise}retry(){this._clearTimeouts(),this._res=this._loadFn(this._opts.loader),this._state={pastDelay:!1,timedOut:!1};let{_res:e,_opts:t}=this;e.loading&&("number"==typeof t.delay&&(0===t.delay?this._state.pastDelay=!0:this._delay=setTimeout(()=>{this._update({pastDelay:!0})},t.delay)),"number"==typeof t.timeout&&(this._timeout=setTimeout(()=>{this._update({timedOut:!0})},t.timeout))),this._res.promise.then(()=>{this._update({}),this._clearTimeouts()}).catch(e=>{this._update({}),this._clearTimeouts()}),this._update({})}_update(e){this._state={...this._state,error:this._res.error,loaded:this._res.loaded,loading:this._res.loading,...e},this._callbacks.forEach(e=>e())}_clearTimeouts(){clearTimeout(this._delay),clearTimeout(this._timeout)}getCurrentValue(){return this._state}subscribe(e){return this._callbacks.add(e),()=>{this._callbacks.delete(e)}}constructor(e,t){this._loadFn=e,this._opts=t,this._callbacks=new Set,this._delay=null,this._timeout=null,this.retry()}}function c(e){return function(e,t){let n=Object.assign({loader:null,loading:null,delay:200,timeout:null,webpack:null,modules:null},t),l=null;function o(){if(!l){let t=new u(e,n);l={getCurrentValue:t.getCurrentValue.bind(t),subscribe:t.subscribe.bind(t),retry:t.retry.bind(t),promise:t.promise.bind(t)}}return l.promise()}if(!s){let e=n.webpack?n.webpack():n.modules;e&&i.push(t=>{for(let n of e)if(t.includes(n))return o()})}function d(e,t){!function(){o();let e=r.default.useContext(a.LoadableContext);e&&Array.isArray(n.modules)&&n.modules.forEach(t=>{e(t)})}();let i=r.default.useSyncExternalStore(l.subscribe,l.getCurrentValue,l.getCurrentValue);return r.default.useImperativeHandle(t,()=>({retry:l.retry}),[]),r.default.useMemo(()=>{var t;return i.loading||i.error?r.default.createElement(n.loading,{isLoading:i.loading,pastDelay:i.pastDelay,timedOut:i.timedOut,error:i.error,retry:l.retry}):i.loaded?r.default.createElement((t=i.loaded)&&t.default?t.default:t,e):null},[e,i])}return d.preload=()=>o(),d.displayName="LoadableComponent",r.default.forwardRef(d)}(d,e)}function f(e,t){let n=[];for(;e.length;){let l=e.pop();n.push(l(t))}return Promise.all(n).then(()=>{if(e.length)return f(e,t)})}c.preloadAll=()=>new Promise((e,t)=>{f(o).then(e,t)}),c.preloadReady=e=>(void 0===e&&(e=[]),new Promise(t=>{let n=()=>(s=!0,t());f(i,e).then(n,n)})),window.__NEXT_PRELOADREADY=c.preloadReady;let h=c},209:function(e,t,n){"use strict";n.r(t),n.d(t,{default:function(){return a}});var l=n(5893),r=n(7294);function a(){var e;let[t,n]=(0,r.useState)(""),[a,o]=(0,r.useState)(!1),[i,s]=(0,r.useState)([]),[d,u]=(0,r.useState)(null),[c,f]=(0,r.useState)([]),[h,m]=(0,r.useState)([]),[p,b]=(0,r.useState)(!1),[y,_]=(0,r.useState)(null),[j,g]=(0,r.useState)(!1),[x,w]=(0,r.useState)(null);async function v(e){e.preventDefault(),"admin"===t?(o(!0),localStorage.setItem("admin","1")):alert("username must be admin")}async function k(){_(null);try{let e=await fetch("/api/admin/tables"),t=await e.json();s(t.tables||[]),b(!!t.readOnly)}catch(e){console.error("fetchTables error",e),_("無法取得表清單："+(e.message||String(e)))}}async function C(e){u(e),_(null);try{let t=await fetch("/api/admin/table/".concat(encodeURIComponent(e),"?limit=100")),n=await t.json();m(n.columns||[]),f(n.rows||[])}catch(e){console.error("fetchRows error",e),_("無法取得資料列："+(e.message||String(e))),m([]),f([])}}async function S(e){if(confirm("確認刪除此筆？")){_(null),w(e),console.log("deleteRow ->",{table:d,id:e});try{let t=await fetch("/api/admin/table/".concat(encodeURIComponent(d),"?id=").concat(encodeURIComponent(e)),{method:"DELETE"}),n={};try{n=await t.json()}catch(e){n={}}if(t.ok)await C(d),_("刪除成功");else{let e=n.error||n.detail||"delete failed";console.warn("delete failed",e),_(String(e)),alert(e)}}catch(e){console.error("deleteRow error",e),_("網路或伺服器錯誤："+(e.message||String(e))),alert("網路或伺服器錯誤："+(e.message||String(e)))}finally{w(null)}}}async function E(){let e=prompt("新表名稱 (只允許英數與底線)");if(!e)return;let t=await fetch("/api/admin/tables",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:e})}),n=await t.json();t.ok?k():alert(n.error||"create failed")}async function O(){if(!d)return alert("select a table first");if(!confirm("確認刪除整個資料表："+d+" ?"))return;let e=await fetch("/api/admin/tables?name=".concat(encodeURIComponent(d)),{method:"DELETE"}),t=await e.json();e.ok?(u(null),k()):alert(t.error||"drop failed")}return(0,r.useEffect)(()=>{a&&k()},[a]),(0,r.useEffect)(()=>{let e;return j&&d&&(e=setInterval(()=>C(d),3e3)),()=>clearInterval(e)},[j,d]),(0,l.jsx)("div",{style:{padding:20,fontFamily:"Arial"},children:a?(0,l.jsxs)("div",{children:[(0,l.jsx)("h2",{children:"Admin (no auth) "}),(0,l.jsxs)("div",{style:{marginBottom:12},children:[(0,l.jsx)("button",{onClick:k,children:"刷新表清單"}),(0,l.jsx)("button",{onClick:E,style:{marginLeft:8},children:"新增表"}),(0,l.jsx)("button",{onClick:O,style:{marginLeft:8},disabled:!d,children:"刪除表"}),(0,l.jsxs)("label",{style:{marginLeft:12},children:["ReadOnly: ",String(p)]}),(0,l.jsxs)("label",{style:{marginLeft:12},children:["Poll: ",(0,l.jsx)("input",{type:"checkbox",checked:j,onChange:e=>g(e.target.checked)})]})]}),(0,l.jsxs)("div",{style:{display:"flex",gap:16},children:[(0,l.jsxs)("div",{style:{width:240},children:[(0,l.jsx)("h4",{children:"Tables"}),(0,l.jsx)("ul",{children:i.map(e=>(0,l.jsx)("li",{children:(0,l.jsx)("a",{href:"#",onClick:t=>{t.preventDefault(),C(e)},children:e})},e))})]}),(0,l.jsxs)("div",{style:{flex:1},children:[(0,l.jsxs)("h4",{children:["Table: ",d||"-"]}),(0,l.jsxs)("div",{style:{marginBottom:8},children:[(0,l.jsx)("button",{onClick:function(){var e;if(!c.length)return alert("no rows");let t=h.join(","),n=c.map(t=>h.map(n=>'"'.concat(null!==(e=t[n])&&void 0!==e?e:"",'"')).join(",")),l=[t,...n].join("\n"),r=new Blob([l],{type:"text/csv;charset=utf-8;"}),a=URL.createObjectURL(r),o=document.createElement("a");o.href=a,o.download="".concat(d||"export",".csv"),o.click()},disabled:!c.length,children:"Export CSV"}),(0,l.jsx)("button",{onClick:function(){var e;if(!c.length)return alert("no rows");let t="| ".concat(h.join(" | ")," |"),n="| ".concat(h.map(()=>"---").join(" | ")," |"),l=c.map(t=>"| ".concat(h.map(n=>null!==(e=t[n])&&void 0!==e?e:"").join(" | ")," |")),r=[t,n,...l].join("\n"),a=new Blob([r],{type:"text/markdown;charset=utf-8;"}),o=URL.createObjectURL(a),i=document.createElement("a");i.href=o,i.download="".concat(d||"export",".md"),i.click()},style:{marginLeft:8},disabled:!c.length,children:"Export Markdown"})]}),(0,l.jsx)("div",{style:{maxHeight:400,overflow:"auto",border:"1px solid #ddd"},children:(0,l.jsxs)("table",{style:{width:"100%",borderCollapse:"collapse"},children:[(0,l.jsx)("thead",{children:(0,l.jsxs)("tr",{children:[h.map(e=>(0,l.jsx)("th",{style:{border:"1px solid #eee",padding:6},children:e},e)),(0,l.jsx)("th",{style:{border:"1px solid #eee",padding:6},children:"_"})]})}),(0,l.jsx)("tbody",{children:c.map(t=>(0,l.jsxs)("tr",{children:[h.map(n=>(0,l.jsx)("td",{style:{border:"1px solid #eee",padding:6},children:String(null!==(e=t[n])&&void 0!==e?e:"")},n)),(0,l.jsx)("td",{style:{border:"1px solid #eee",padding:6},children:!p&&(0,l.jsx)("button",{onClick:()=>S(t.id),children:"Del"})})]},t.id))})]})})]})]})]}):(0,l.jsxs)("form",{onSubmit:v,children:[(0,l.jsxs)("label",{children:["Username: ",(0,l.jsx)("input",{value:t,onChange:e=>n(e.target.value)})]}),(0,l.jsx)("button",{type:"submit",children:"Login"})]})})}n(5152)},5152:function(e,t,n){n(5677)}},function(e){e.O(0,[774,888,179],function(){return e(e.s=8195)}),_N_E=e.O()}]);